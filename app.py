# app.py
import streamlit as st # Streamlit –∏–º–ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –∏–∑ –ø–µ—Ä–≤—ã—Ö
import datetime
import sys
import os

# --- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –ü–ï–†–í–ê–Ø –∫–æ–º–∞–Ω–¥–∞ Streamlit ---
st.set_page_config(page_title="–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –í–µ—Å—Ç–Ω–∏–∫–™", layout="wide")

# --- –ò–º–ø–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–æ–¥—É–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏ –ü–û–°–õ–ï set_page_config
try:
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—à–∏–±–∫–∏
    from modules.generator import generate_news, last_error
    from modules.models import NewsReport
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    # st.sidebar.success("–ú–æ–¥—É–ª–∏ 'generator' –∏ 'models' –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.")
except ImportError as app_import_error:
    st.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ ('modules.generator' –∏–ª–∏ 'modules.models').")
    st.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {app_import_error}")
    st.error("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ –∏ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ `modules/generator.py` –∏ `modules/models.py`.")
    # –í—ã–≤–æ–¥–∏–º –ø—É—Ç–∏ –¥–ª—è –ø–æ–º–æ—â–∏ –≤ –æ—Ç–ª–∞–¥–∫–µ, –µ—Å–ª–∏ –∏–º–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è
    st.error(f"–¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {os.getcwd()}")
    st.error(f"–ü—É—Ç–∏ –ø–æ–∏—Å–∫–∞ Python: {sys.path}")
    st.stop() # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ –º–æ–¥—É–ª–µ–π –æ–Ω–æ –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ
except Exception as app_other_error:
     st.error(f"–î—Ä—É–≥–∞—è –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª–µ–π: {app_other_error}")
     st.stop()


# --- –û—Å–Ω–æ–≤–Ω–æ–π UI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
st.title("üìú –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –í–µ—Å—Ç–Ω–∏–∫–™ üì∞")
st.caption("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Å–µ–≤–¥–æ-–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ –±–∞–∑–µ LLM")

# --- –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ---
col1, col2 = st.columns([1, 2])

with col1:
    default_date = datetime.date(1789, 7, 14)
    selected_date = st.date_input(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –≤—ã–ø—É—Å–∫–∞ –≥–∞–∑–µ—Ç—ã:",
        value=default_date,
        min_value=datetime.date(1000, 1, 1), # –û–≥—Ä–∞–Ω–∏—á–∏–º —Ä–∞–∑—É–º–Ω–æ
        max_value=datetime.date.today()
    )
    # –§–æ—Ä–º–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    selected_date_str = selected_date.strftime("%d %B %Y")

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è —ç–ø–æ—Ö–∏
    era_options = ["XVIII", "XIX", "XVII", "XX"] # –î–æ–±–∞–≤—å—Ç–µ –Ω—É–∂–Ω—ã–µ
    selected_era = st.selectbox("–°—Ç–∏–ª—å –∫–∞–∫–æ–≥–æ –≤–µ–∫–∞ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?", era_options, index=0)

    num_articles = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –≤ —Å–≤–æ–¥–∫–µ:", min_value=1, max_value=5, value=3)

    generate_button = st.button("‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –í–µ—Å—Ç–Ω–∏–∫–™!")


# --- –û–±–ª–∞—Å—Ç—å –≤—ã–≤–æ–¥–∞ ---
with col2:
    st.subheader(f"–í—ã–ø—É—Å–∫—ä –æ—Ç—ä {selected_date_str} ({selected_era} –≤—£–∫—ä)")

    if generate_button:
        # –£–±–µ–¥–∏–º—Å—è –µ—â–µ —Ä–∞–∑, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ (—Ö–æ—Ç—è st.stop() –≤—ã—à–µ –¥–æ–ª–∂–µ–Ω –±—ã–ª –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ)
        if 'generate_news' in globals():
            with st.spinner(f"‚è≥ –†–µ–¥–∞–∫—Ü—ñ—è '{'–•—Ä–æ–Ω–æ–≥—Ä–∞—Ñ—ä'.upper()}' –≥–æ—Ç–æ–≤–∏—Ç—ä —Å–≤—£–∂—ñ–π –Ω–æ–º–µ—Ä—ä..."):
                # –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                news_report: NewsReport = generate_news(
                    target_date=selected_date_str,
                    era_style=selected_era,
                    num_articles=num_articles
                )

                # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                if news_report and news_report.articles:
                    st.success("üì∞ –°–≤—£–∂—ñ–π –Ω–æ–º–µ—Ä—ä –≥–æ—Ç–æ–≤—ä!")
                    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π
                    for i, article in enumerate(news_report.articles):
                        st.markdown(f"---")
                        st.markdown(f"### {i+1}. {article.headline}")
                        st.markdown(f"**–†—É–±—Ä–∏–∫–∞:** {article.rubric}")
                        st.markdown(f"*{article.date_location}*")
                        st.write(article.body)
                        st.caption(f"–†–µ–ø–æ—Ä—Ç–∞–∂—ä –≤–µ–ª—ä: {article.reporter}")
                # –°–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π, –Ω–æ –∏ –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º last_error)
                # last_error –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ generator.py
                elif last_error is None:
                     st.info("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã).")
                # –ï—Å–ª–∏ –±—ã–ª–∞ –æ—à–∏–±–∫–∞, —Å–æ–æ–±—â–µ–Ω–∏—è st.error/st.warning —É–∂–µ –±—ã–ª–∏ –≤—ã–≤–µ–¥–µ–Ω—ã –≤–Ω—É—Ç—Ä–∏ generate_news

        else:
             # –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–ª—è—Ç—å—Å—è, –µ—Å–ª–∏ st.stop() —Å—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–º–ø–æ—Ä—Ç–∞
             st.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.")

    else:
        st.info("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π.")


# --- –ü–æ–¥–≤–∞–ª ---
st.markdown("---")
st.caption("–°–æ–∑–¥–∞–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM –∏ Streamlit.")